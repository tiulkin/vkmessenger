/*
 * File: app/view/FirstScreen.js
 *
 * This file was generated by Sencha Architect version 3.0.1.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.3.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.3.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('VKM.view.FirstScreen', {
    extend: 'Ext.Panel',

    requires: [
        'Ext.Container',
        'Ext.Spacer',
        'Ext.Button'
    ],

    config: {
        fullscreen: true,
        itemId: 'firstScreen',
        layout: {
            type: 'vbox',
            align: 'stretchmax',
            pack: 'center'
        },
        items: [
            {
                xtype: 'container',
                flex: 4,
                style: {
                    background: 'url(resources/images/Main.png) no-repeat center center fixed',
                    '-webkit-background-size': 'cover',
                    /* For WebKit*/'background-size': 'cover'//  "background-size": "100%";
                },
                layout: {
                    type: 'vbox',
                    align: 'center',
                    pack: 'center'
                },
                items: [
                    {
                        xtype: 'spacer'
                    },
                    {
                        xtype: 'button',
                        handler: function(button, e) {
                            var url='https://oauth.vk.com/authorize?client_id=3967300&scope=notify,friends,photos,audio,video,docs,notes,status,messages,notifications&redirect_uri=https://oauth.vk.com/blank.html&display=mobile&response_type=token';

                            VKM.app.authenticate=function () {
                                window.authCount = 0;
                                var name=VKM.app.uuid();
                                window.authWin = window.open(url, name,"",true);
                                VKM.app.globals.loginWindow=window.authWin;
                                VKM.app.watchOAuth();

                                return;
                            };

                            VKM.app.watchOAuth= function () {
                                window.intv = self.setInterval(function () {
                                    window.authCount = window.authCount + 1;
                                    if (window.authWin && window.authWin.location) {
                                        var currentURL = window.authWin.location.href;
                                        var inCallback = currentURL.indexOf("access_token=");

                                        if (inCallback >= 0) {
                                            var authData = currentURL.substr(currentURL.indexOf("#"));
                                            window.clearInterval(intv);
                                            window.authWin.close();
                                            VKM.app.globals.authData=VKM.app.getJsonFromUrl(authData);
                                            VKM.app.globals.authData['_id']='authData';
                                            VKM.app.globals.authData.expiresTime=Ext.DateExtras.now()+1000*parseInt(VKM.app.globals.authData.expires_in);
                                            var settingsStore=Ext.getStore('settings');
                                            var record=new VKM.model.localConfig({id:'expires_in',value:VKM.app.globals.authData['expires_in']});
                                            settingsStore.add(record);
                                            record.save();
                                            record=new VKM.model.localConfig({id:'access_token',value:VKM.app.globals.authData['access_token']});
                                            settingsStore.add(record);
                                            record.save();
                                            record=new VKM.model.localConfig({id:'user_id',value:VKM.app.globals.authData['user_id']});
                                            settingsStore.add(record);
                                            record.save();
                                            record=new VKM.model.localConfig({id:'expiresTime',value:VKM.app.globals.authData['expiresTime']});
                                            settingsStore.add(record);
                                            record.save();
                                            settingsStore.sync();
                                            console.log(settingsStore);
                                            VKM.app.getController('Login').go();

                                        }
                                    }
                                    if (window.authCount > 600) {
                                        //alert('5 minutes login time out');
                                        window.authCount  =0;
                                        window.clearInterval(intv);
                                        window.authWin.close();
                                    }
                                }, 500);
                            }
                            VKM.app.authenticate();

                            // VKM.app.watchOAuth= function () {
                            //     VKM.app.globals.int = self.setInterval(function () {
                            //         //         console.log(VKM.app.globals.authCount);
                            //         //         console.log(VKM.app.globals.authWin);
                            //         //         console.log(VKM.app.globals.authWin.location);
                            //         //         console.log(VKM.app.globals.authWin.location.href);
                            //         VKM.app.globals.authCount = VKM.app.globals.authCount + 1;

                            //         if (VKM.app.globals.authWin) {

                            //             var currentURL='';
                            //             if(tizen)
                            //             {
                            //                 currentURL = VKM.app.globals.authWin.uri;
                            //             }
                            //             else
                            //             {
                            //                 currentURL = VKM.app.globals.authWin.location.href;
                            //             }
                            //             console.log(currentURL);
                            //             VKM.app.globals.authWin.uri;
                            //             VKM.app.globals.authWin.uri;
                            //             var inCallback = currentURL.indexOf("access_token=");

                            //             if (inCallback >= 0) {
                            //                 var authData = currentURL.substr(currentURL.indexOf("#"));
                            //                 window.clearInterval(int)
                            //                 VKM.app.globals.authWin.destroy();
                            //                 VKM.app.globals.authData=VKM.app.getJsonFromUrl(authData);
                            //                 VKM.app.globals.authData['_id']='authData';

                            //                 VKM.app.globals.authData.expiresTime=Ext.DateExtras.now()+1000*parseInt(VKM.app.globals.authData.expires_in);
                            //                 VKM.app.globals.localDB.get('authData',function(err, doc){
                            //                     if(doc)
                            //                     {
                            //                         doc.expires_in=VKM.app.globals.authData['expires_in'];
                            //                         doc.access_token = VKM.app.globals.authData['access_token'];
                            //                         doc.user_id = VKM.app.globals.authData['user_id'];
                            //                         doc.expiresTime = VKM.app.globals.authData['expiresTime'];

                            //                     }
                            //                     else
                            //                     {
                            //                         doc={
                            //                             _id:'authData',
                            //                             expires_in:VKM.app.globals.authData['expires_in'],
                            //                             access_token:VKM.app.globals.authData['access_token'],
                            //                             user_id : VKM.app.globals.authData['user_id'],
                            //                             expiresTime : VKM.app.globals.authData['expiresTime']
                            //                         }
                            //                     }
                            //                     VKM.app.globals.localDB.put(doc,function(err, doc){
                            //                         VKM.app.getController('Login').go();
                            //                     })
                            //                 })

                            //                 // process here
                            //             }
                            //         }
                            //         if (VKM.app.globals.authCount > 600) {
                            //             //alert('5 minutes login time out');
                            //             VKM.app.globals.authCount  =0;
                            //             VKM.app.globals.clearInterval(VKM.app.globals.int)
                            //             VKM.app.globals.authWin.destroy();
                            //             //VKM.app.globals.authWin.close();
                            //         }
                            //     }, 500);
                            // }

                            // VKM.app.authenticate=function () {
                            //     VKM.app.globals.authCount = 0;

                            //
                            //         VKM.app.globals.authWin = appControl;
                            //         //         var service = new tizen.ApplicationService('http:tizen.org/appcontrol/operation/default', url);
                            //         //         tizen.application.launchService(service, 'org.tizen.browser', function() {
                            //         //             tizen.logger.info("browser launched");
                            //         //         }, function() {
                            //         //             tizen.view.showPopup("Unable to launch browser");
                            //     }

                            // }
                            // //VKM.app.watchOAuth();



                        },
                        locales: {
                            text: 'labels.Login'
                        },
                        height: 50,
                        itemId: 'signin',
                        style: {
                            'margin-bottom': '3em'
                        },
                        ui: 'action',
                        width: '80%'
                    }
                ]
            },
            {
                xtype: 'container',
                flex: 1,
                html: '',
                layout: {
                    type: 'vbox',
                    align: 'center',
                    pack: 'center'
                },
                items: [
                    {
                        xtype: 'container',
                        layout: {
                            type: 'vbox',
                            align: 'center',
                            pack: 'center'
                        },
                        items: [
                            {
                                xtype: 'component',
                                itemId: 'mycomponent',
                                padding: '10px',
                                style: {
                                    color: '#345777',
                                    'font-weight': 'bold',
                                    'font-size': '1.2em',
                                    'text-decoration': 'underline'
                                },
                                listeners: [
                                    {
                                        fn: function(element, eOpts) {
                                            element.setHtml(ux.locale.Manager.get('labels.Signup'));
                                            console.log(ux.locale.Manager.get('labels.Signup'));
                                            element.dom.addEventListener('click',function(e){
                                                var appControl = new tizen.ApplicationControl("http://tizen.org/appcontrol/operation/view", "http://m.vk.com/join");
                                                tizen.application.launchAppControl(appControl, null,
                                                function() {
                                                    console.log("browser opened");

                                                },
                                                function(e) { console.log("browser error: " + e.message); }
                                                );


                                            })
                                        },
                                        event: 'painted'
                                    }
                                ]
                            },
                            {
                                xtype: 'component',
                                itemId: 'mycomponent1',
                                padding: '10px',
                                style: {
                                    'font-size': '0.8em',
                                    'text-align': 'center'
                                },
                                listeners: [
                                    {
                                        fn: function(element, eOpts) {
                                            element.setHtml(ux.locale.Manager.get('labels.youcanmessage'))
                                        },
                                        event: 'painted'
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }

});